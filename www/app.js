"use strict";(()=>{var d=class{constructor(e,t,i,c){this.audioEl=e,this.pc=t,this.dc=i,this.micTrack=c,this.eventListeners=new Map,this.dc.addEventListener("message",o=>{let l=o.data;this.eventListeners.forEach(s=>{s(l)})})}close(){console.log("Closing WebRTC connection"),this.micTrack&&this.micTrack.stop(),this.dc&&this.dc.close(),this.pc&&this.pc.close()}get volume(){return this.audioEl.volume}set volume(e){this.audioEl.volume=Math.max(0,Math.min(1,e))}get audioMuted(){return this.audioEl.muted}set audioMuted(e){this.audioEl.muted=e}get micMuted(){return!this.micTrack.enabled}set micMuted(e){this.micTrack.enabled=!e}send(e){console.log("Sending event:",e),this.dc.send(JSON.stringify(e))}addEventListener(e,t){this.eventListeners.set(e,t)}removeEventListener(e){this.eventListeners.delete(e)}getAudioElement(){return this.audioEl}getPeerConnection(){return this.pc}getDataChannel(){return this.dc}getMicrophoneTrack(){return this.micTrack}};var h=class h{constructor(e,t){this.onMuteChange=t;this.muted=!0;this.holdTimeout=null;this.pushToTalkActive=!1;this.suppressNextClick=!1;this.element=e,this.element.addEventListener("mousedown",()=>this.startPress()),this.element.addEventListener("touchstart",()=>this.startPress()),this.element.ownerDocument.addEventListener("keydown",i=>{i.key===" "&&!i.repeat&&(i.preventDefault(),this.startPress())}),this.element.addEventListener("mouseup",()=>this.endPress()),this.element.addEventListener("touchend",()=>this.endPress()),this.element.ownerDocument.addEventListener("keyup",i=>{i.key===" "&&this.endPress()}),this.element.addEventListener("click",i=>this.onClick(i))}isMuted(){return this.muted}isPushToTalkActive(){return this.pushToTalkActive}setMuted(e){this.muted!==e&&(this.muted=e,this.onMuteChange(e))}startPushToTalk(){this.pushToTalkActive=!0,this.setMuted(!1)}stopPushToTalk(){this.pushToTalkActive&&(this.pushToTalkActive=!1,this.setMuted(!0))}toggle(){this.setMuted(!this.muted)}startPress(){this.holdTimeout=window.setTimeout(()=>{this.startPushToTalk(),this.holdTimeout=null},h.HOLD_DELAY)}endPress(){this.suppressNextClick=!0,window.setTimeout(()=>{this.suppressNextClick=!1},0),this.holdTimeout?(clearTimeout(this.holdTimeout),this.holdTimeout=null,this.toggle()):this.stopPushToTalk()}onClick(e){if(this.suppressNextClick){e.preventDefault(),e.stopImmediatePropagation();return}this.toggle()}};h.HOLD_DELAY=200;var u=h;async function T(a,e){let t=new RTCPeerConnection,i=document.createElement("audio");i.autoplay=!0,t.ontrack=m=>i.srcObject=m.streams[0];let o=(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks()[0];t.addTrack(o),o.enabled=!1;let l=t.createDataChannel("oai-events"),s=await t.createOffer();await t.setLocalDescription(s);let n={type:"answer",sdp:await(await fetch(`https://api.openai.com/v1/realtime/calls?model=${e}`,{method:"POST",body:s.sdp,headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/sdp"}})).text()};return await t.setRemoteDescription(n),new d(i,t,l,o)}var p=class extends Shiny.OutputBinding{find(e){return $(e).find(".shinyrealtime")}renderValue(e,t){let i=this.getId(e),{key:c,model:o}=JSON.parse(t),l=T(c,o).then(s=>{$(document).on("shiny:disconnected",function(){console.log("Shiny disconnected, cleaning up any WebRTC connections"),s.close()});let r=e.querySelector(".mic-toggle-btn"),v=new u(r,n=>{s.micMuted=n,n?(r.classList.remove("active","btn-danger"),r.classList.add("btn-secondary")):(r.classList.remove("btn-secondary"),r.classList.add("active","btn-danger"))});return $(e).data("rtConnection",s),s.addEventListener("shiny",n=>{Shiny.setInputValue(i+"_event",n,{priority:"event"})}),Shiny.addCustomMessageHandler("realtime_send",n=>{n.forEach(m=>s.send(m))}),s})}unsubscribe(e){let t=$(e).data("rtConnection");t&&typeof t.close=="function"&&(console.log("Closing WebRTC connection due to element unsubscribe"),t.close())}};Shiny.outputBindings.register(new p,"realtime-output");Shiny.addCustomMessageHandler("play_audio",({selector:a})=>{let e=document.querySelector(a);e?(e.currentTime=0,e.play().catch(t=>{console.error("Error playing audio:",t)})):console.error("Audio element not found for selector:",a)});})();
//# sourceMappingURL=app.js.map
