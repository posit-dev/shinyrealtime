"use strict";(()=>{async function p(e){let o=new RTCPeerConnection,u=document.createElement("audio");u.autoplay=!0,o.ontrack=n=>u.srcObject=n.streams[0];let t=(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks()[0];o.addTrack(t),t.enabled=!1;let i=o.createDataChannel("oai-events"),s=new Map;i.addEventListener("message",n=>{let d=n.data;console.log("Received event:",d),s.forEach(h=>{h(d)})});let r=await o.createOffer();await o.setLocalDescription(r);let f={type:"answer",sdp:await(await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2025-06-03",{method:"POST",body:r.sdp,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/sdp"}})).text()};return await o.setRemoteDescription(f),{close:()=>{console.log("Closing WebRTC connection"),t&&t.stop(),i&&i.close(),o&&o.close()},get volume(){return u.volume},set volume(n){u.volume=Math.max(0,Math.min(1,n))},get audioMuted(){return u.muted},set audioMuted(n){u.muted=n},get micMuted(){return!t.enabled},set micMuted(n){t.enabled=!n},send:n=>{console.log("Sending event:",n),i.send(JSON.stringify(n))},addEventListener:(n,d)=>{s.set(n,d)},removeEventListener:n=>{s.delete(n)},getAudioElement:()=>u,getPeerConnection:()=>o,getDataChannel:()=>i,getMicrophoneTrack:()=>t}}var l=new Shiny.OutputBinding;$.extend(l,{find:function(e){return $(e).find(".shinyrealtime")},renderValue:function(e,o){let u=this.getId(e),m=p(o).then(t=>{$(document).on("shiny:disconnected",function(){console.log("Shiny disconnected, cleaning up any WebRTC connections"),t.close()}),$(e).find(".btn-unmute").show();let i=!1,s=null,r=200;return $(e).on("mousedown touchstart",".btn-mute, .btn-unmute",function(a){s!==null&&clearTimeout(s),s=window.setTimeout(()=>{i=!0,$(a.target).closest(".btn-unmute").length>0&&(t.micMuted=!1,$(e).find(".btn-unmute").hide(),$(e).find(".btn-mute").show())},r)}),$(document).on("mouseup touchend",function(a){if(s!==null&&(clearTimeout(s),s=null),i)return i=!1,t.micMuted=!0,$(e).find(".btn-mute").hide(),$(e).find(".btn-unmute").show(),a.stopPropagation(),!1}),$(e).on("click",".btn-mute",function(){i||(t.micMuted=!0,$(e).find(".btn-mute").hide(),$(e).find(".btn-unmute").show())}),$(e).on("click",".btn-unmute",function(){i||(t.micMuted=!1,$(e).find(".btn-unmute").hide(),$(e).find(".btn-mute").show())}),$(e).data("rtConnection",t),t.addEventListener("shiny",a=>{Shiny.setInputValue(u+"_event",a,{priority:"event"})}),Shiny.addCustomMessageHandler("realtime_send",a=>{Array.isArray(a)?a.forEach(c=>t.send(c)):t.send(a)}),t})},unsubscribe:function(e){let o=$(e).data("rtConnection");o&&typeof o.close=="function"&&(console.log("Closing WebRTC connection due to element unsubscribe"),o.close())}});Shiny.outputBindings.register(l,"realtime-output");})();
//# sourceMappingURL=app.js.map
