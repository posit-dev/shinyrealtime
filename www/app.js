"use strict";(()=>{var u=class u{constructor(e,o){this.onMuteChange=o;this.muted=!0;this.holdTimeout=null;this.pushToTalkActive=!1;this.suppressNextClick=!1;this.element=e,this.element.addEventListener("mousedown",()=>this.startPress()),this.element.addEventListener("touchstart",()=>this.startPress()),this.element.ownerDocument.addEventListener("keydown",r=>{r.key===" "&&!r.repeat&&(r.preventDefault(),this.startPress())}),this.element.addEventListener("mouseup",()=>this.endPress()),this.element.addEventListener("touchend",()=>this.endPress()),this.element.ownerDocument.addEventListener("keyup",r=>{r.key===" "&&this.endPress()}),this.element.addEventListener("click",r=>this.onClick(r))}isMuted(){return this.muted}isPushToTalkActive(){return this.pushToTalkActive}setMuted(e){this.muted!==e&&(this.muted=e,this.onMuteChange(e))}startPushToTalk(){this.pushToTalkActive=!0,this.setMuted(!1)}stopPushToTalk(){this.pushToTalkActive&&(this.pushToTalkActive=!1,this.setMuted(!0))}toggle(){this.setMuted(!this.muted)}startPress(){this.holdTimeout=window.setTimeout(()=>{this.startPushToTalk(),this.holdTimeout=null},u.HOLD_DELAY)}endPress(){this.suppressNextClick=!0,window.setTimeout(()=>{this.suppressNextClick=!1},0),this.holdTimeout?(clearTimeout(this.holdTimeout),this.holdTimeout=null,this.toggle()):this.stopPushToTalk()}onClick(e){if(this.suppressNextClick){e.preventDefault(),e.stopImmediatePropagation();return}this.toggle()}};u.HOLD_DELAY=200;var d=u;async function g(a){let e=new RTCPeerConnection,o=document.createElement("audio");o.autoplay=!0,e.ontrack=t=>o.srcObject=t.streams[0];let n=(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks()[0];e.addTrack(n),n.enabled=!1;let s=e.createDataChannel("oai-events"),l=new Map;s.addEventListener("message",t=>{let c=t.data;console.log("Received event:",c),l.forEach(v=>{v(c)})});let i=await e.createOffer();await e.setLocalDescription(i);let p={type:"answer",sdp:await(await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2025-06-03",{method:"POST",body:i.sdp,headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/sdp"}})).text()};return await e.setRemoteDescription(p),{close:()=>{console.log("Closing WebRTC connection"),n&&n.stop(),s&&s.close(),e&&e.close()},get volume(){return o.volume},set volume(t){o.volume=Math.max(0,Math.min(1,t))},get audioMuted(){return o.muted},set audioMuted(t){o.muted=t},get micMuted(){return!n.enabled},set micMuted(t){n.enabled=!t},send:t=>{console.log("Sending event:",t),s.send(JSON.stringify(t))},addEventListener:(t,c)=>{l.set(t,c)},removeEventListener:t=>{l.delete(t)},getAudioElement:()=>o,getPeerConnection:()=>e,getDataChannel:()=>s,getMicrophoneTrack:()=>n}}var h=new Shiny.OutputBinding;$.extend(h,{find:function(a){return $(a).find(".shinyrealtime")},renderValue:function(a,e){let o=this.getId(a),r=g(e).then(n=>{$(document).on("shiny:disconnected",function(){console.log("Shiny disconnected, cleaning up any WebRTC connections"),n.close()});let s=a.querySelector(".mic-toggle-btn"),l=new d(s,i=>{n.micMuted=i,i?(s.classList.remove("active","btn-danger"),s.classList.add("btn-secondary")):(s.classList.remove("btn-secondary"),s.classList.add("active","btn-danger"))});return $(a).data("rtConnection",n),n.addEventListener("shiny",i=>{Shiny.setInputValue(o+"_event",i,{priority:"event"})}),Shiny.addCustomMessageHandler("realtime_send",i=>{Array.isArray(i)?i.forEach(m=>n.send(m)):n.send(i)}),n})},unsubscribe:function(a){let e=$(a).data("rtConnection");e&&typeof e.close=="function"&&(console.log("Closing WebRTC connection due to element unsubscribe"),e.close())}});Shiny.outputBindings.register(h,"realtime-output");})();
//# sourceMappingURL=app.js.map
